# ========================================================
# TMUX ULTIMATE WORKSPACE CONFIGURATION
# Version: 2.0 - Dashboard Edition
# ========================================================

##### META CONFIGURATION #####

# Version check
if-shell '[ "$(echo "$TMUX_VERSION >= 3.2" | bc)" = 1 ]' 'set -g @tmux_version "modern"' 'set -g @tmux_version "legacy"'

##### CORE SETTINGS #####

set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB,tmux-256color:RGB"
set -g default-command "${SHELL}"
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g automatic-rename off
set -g allow-rename off
set -g set-clipboard on
set -g focus-events on
set -sg escape-time 0
set -g history-limit 50000
set -g display-time 4000
set -g display-panes-time 2000
set -g status-keys emacs
set -g mode-keys vi
set -g mouse on
set -g monitor-activity on
set -g visual-activity off
set -g visual-bell off
set -g bell-action none

##### PLUGIN MANAGEMENT #####

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-git'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'

# Optional plugins (uncomment if needed)
# set -g @plugin 'nhdaly/tmux-better-mouse-mode'
# set -g @plugin 'wfxr/tmux-fzf-url'
# set -g @plugin 'MunifTanjim/tmux-mode-indicator'
# set -g @plugin 'jaclu/tmux-menus'

##### PERSISTENCE & RESTORE #####

set -g @continuum-restore 'on'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'fullscreen'
set -g @continuum-save-interval '5'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes 'ssh psql mysql sqlite3 python ipython irb node nvim vim'
set -g @resurrect-strategy-nvim 'session'

##### THEME - CATPPUCCIN MOCHA #####

set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_window_left_separator ""
set -g @catppuccin_window_right_separator " "
set -g @catppuccin_window_middle_separator " █"
set -g @catppuccin_window_number_position "right"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_window_current_text "#W"
set -g @catppuccin_status_modules_right "directory session date_time"
set -g @catppuccin_status_left_separator  ""
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"
set -g @catppuccin_directory_text "#{pane_current_path}"

##### PANE STYLING #####

set -g pane-border-style "fg=#585b70"
set -g pane-active-border-style "fg=#f5c2e7,bg=#1e1e2e"
set -g display-panes-colour "#f5c2e7"
set -g display-panes-active-colour "#cba6f7"

##### STATUS BAR #####

set -g status on
set -g status-position top
set -g status-interval 2
set -g status-justify centre
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

set -g status-left-length 100
set -g status-right-length 150

# Left: Session info
set -g status-left "#[fg=#f5c2e7,bold]#[fg=#1e1e2E,bg=#f5c2e7] 󰆍 #S #[fg=#f5c2e7,bg=#1e1e2e]"

# Right: System dashboard
set -g status-right "\
#{git_branch} \
#[fg=#89dceb]#[fg=#1e1e2e,bg=#89dceb]  #{cpu_percentage} \
#[fg=#f9e2af]#[fg=#1e1e2e,bg=#f9e2af] 󰁹 #{ram_percentage} \
#[fg=#a6e3a1]#[fg=#1e1e2e,bg=#a6e3a1] 󰍛 #{loadavg} \
#[fg=#fab387]#[fg=#1e1e2e,bg=#fab387] 󰁿 #{battery_percentage} #{battery_icon} \
#[fg=#cba6f7]#[fg=#1e1e2e,bg=#cba6f7] 󰃭 %b %d \
#[fg=#f38ba8]#[fg=#1e1e2e,bg=#f38ba8] 󰥔 %H:%M #[fg=#f38ba8]"

##### WINDOW STYLING #####

setw -g window-status-format "#[fg=#585b70]#[fg=#cdd6f4,bg=#313244]#I:#W#[fg=#313244]"
setw -g window-status-current-format "#[fg=#f5c2e7,bold]#[fg=#1e1e2e,bg=#f5c2e7] 󰖟 #I:#W #[fg=#f5c2e7]"
setw -g window-status-separator ""

##### =====================================================
##### TELESCOPE-STYLE WORKSPACE NAVIGATION
##### =====================================================

##### SESSION MANAGEMENT #####

# Fuzzy find and switch sessions (Ctrl+f)
bind-key -n C-f run-shell "
  selected=\$(tmux list-sessions -F '#{?session_attached,󰍽 ,󰈈 }#{session_name} [#{session_windows} windows]' | \
    fzf --reverse \
        --prompt='󰀂  Switch to session > ' \
        --header='󱂬  TMUX Sessions (attached: 󰍽, detached: 󰈈)' \
        --height 60% \
        --layout=reverse \
        --border=rounded \
        --color='fg:#cdd6f4,bg:#1e1e2e,hl:#f5c2e7,fg+:#cdd6f4,bg+:#313244,hl+:#f5c2e7' \
        --color='info:#cba6f7,prompt:#89b4fa,pointer:#f5c2e7,marker:#f5e0dc,spinner:#f5c2e7,header:#a6e3a1' \
        --preview='tmux list-windows -t {2}' \
        --preview-window='right,40%,border-left' \
        --bind='ctrl-space:toggle-preview' \
        --bind='ctrl-a:select-all+accept' \
        --bind='ctrl-d:deselect-all' \
        --bind='ctrl-t:toggle-all' \
        --bind='ctrl-s:toggle-sort')
  
  if [ -n \"\$selected\" ]; then
    session_name=\$(echo \"\$selected\" | awk '{print \$2}')
    tmux switch-client -t \"\$session_name\"
  fi
"

# Create new session from directory (Ctrl+n)
bind-key -n C-n run-shell "
  selected_dir=\$(find ~/ ~/projects ~/work ~/code ~/Documents -type d 2>/dev/null | \
    fzf --reverse \
        --prompt='󰑐  Create session in directory > ' \
        --header='󰝰  Select Directory for New Session' \
        --height 70% \
        --layout=reverse \
        --border=rounded \
        --color='fg:#cdd6f4,bg:#1e1e2e,hl:#a6e3a1,fg+:#cdd6f4,bg+:#313244,hl+:#a6e3a1' \
        --preview='ls -la {}' \
        --preview-window='right,60%,border-left' \
        --bind='ctrl-space:toggle-preview')
  
  if [ -n \"\$selected_dir\" ]; then
    session_name=\$(basename \"\$selected_dir\" | tr ' .' '_' | tr '[:upper:]' '[:lower:]')
    
    # Check if session exists
    if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
      # Ask to attach or create new
      echo -e \"Session '\$session_name' already exists.\\n1) Attach to existing\\n2) Create new with timestamp\" > /tmp/tmux_choice
      choice=\$(echo -e \"1\\n2\" | fzf --prompt='Choose action: ')
      
      if [ \"\$choice\" = \"2\" ]; then
        session_name=\"\${session_name}-\$(date +%H%M%S)\"
      fi
    fi
    
    tmux new-session -d -c \"\$selected_dir\" -s \"\$session_name\"
    tmux switch-client -t \"\$session_name\"
  fi
"

# Kill sessions (Ctrl+k)
bind-key -n C-k run-shell "
  selected=\$(tmux list-sessions -F '#{?session_attached,󰍽 ,󰈈 }#{session_name}' | \
    fzf --multi \
        --reverse \
        --prompt='󰮯  Kill sessions > ' \
        --header='Select sessions to kill (Tab to select multiple, Ctrl+A select all)' \
        --height 60% \
        --layout=reverse \
        --border=rounded \
        --color='fg:#cdd6f4,bg:#1e1e2e,hl:#f38ba8,fg+:#cdd6f4,bg+:#313244,hl+:#f38ba8' \
        --bind='ctrl-a:select-all' \
        --bind='ctrl-d:deselect-all')
  
  if [ -n \"\$selected\" ]; then
    echo \"\$selected\" | while read line; do
      session_name=\$(echo \"\$line\" | awk '{print \$2}')
      # Detach clients first if attached
      tmux detach-client -s \"\$session_name\" 2>/dev/null
      tmux kill-session -t \"\$session_name\" 2>/dev/null
    done
  fi
"

##### WINDOW MANAGEMENT #####

# Fuzzy find and switch windows (Ctrl+w)
bind-key -n C-w run-shell "
  selected=\$(tmux list-windows -F '#I: #W #{?window_active,󰅂,} [#{window_panes} panes]' | \
    fzf --reverse \
        --prompt='󰀂  Switch to window > ' \
        --header='󱂬  Current Session Windows (active: 󰅂)' \
        --height 60% \
        --layout=reverse \
        --border=rounded \
        --color='fg:#cdd6f4,bg:#1e1e2e,hl:#89b4fa,fg+:#cdd6f4,bg+:#313244,hl+:#89b4fa' \
        --preview='tmux list-panes -t {1} -F \"#{pane_index}: #{pane_title} [#{pane_current_command}]\"' \
        --preview-window='right,40%,border-left')
  
  if [ -n \"\$selected\" ]; then
    window_index=\$(echo \"\$selected\" | cut -d ':' -f1)
    tmux select-window -t \"\$window_index\"
  fi
"

# Create new window with prompt (Ctrl+Shift+n)
bind-key -n C-N run-shell "
  window_name=\$(echo | fzf --print-query --prompt='Window name > ' | head -n1)
  
  if [ -n \"\$window_name\" ]; then
    tmux new-window -c \"#{pane_current_path}\" -n \"\$window_name\"
  else
    tmux new-window -c \"#{pane_current_path}\"
  fi
"

##### PANE MANAGEMENT #####

# Fuzzy find and switch panes (Ctrl+p)
bind-key -n C-p run-shell "
  selected=\$(tmux list-panes -F '#{pane_index}: #{pane_title} [#{pane_current_command}] #{?pane_active,󰅂,}' | \
    fzf --reverse \
        --prompt='󰀂  Switch to pane > ' \
        --header='󱂬  Panes (active: 󰅂)' \
        --height 60% \
        --layout=reverse \
        --border=rounded \
        --color='fg:#cdd6f4,bg:#1e1e2e,hl:#cba6f7,fg+:#cdd6f4,bg+:#313244,hl+:#cba6f7' \
        --preview='tmux capture-pane -pe -t {1}' \
        --preview-window='right,60%,border-left')
  
  if [ -n \"\$selected\" ]; then
    pane_index=\$(echo \"\$selected\" | cut -d ':' -f1)
    tmux select-pane -t \"\$pane_index\"
  fi
"

##### =====================================================
##### WORKSPACE PRESETS
##### =====================================================

# Development workspace (Alt+1)
bind -n M-1 run-shell "
  session_name=\"dev-\$(date +%Y%m%d)\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -c ~/projects -n 'editor'
    tmux send-keys -t \"\$session_name:1\" 'clear' C-m
    tmux new-window -t \"\$session_name:2\" -n 'server' -c ~/projects
    tmux new-window -t \"\$session_name:3\" -n 'shell' -c ~/projects
    tmux new-window -t \"\$session_name:4\" -n 'logs' -c ~/projects
    tmux new-window -t \"\$session_name:5\" -n 'git' -c ~/projects
    tmux select-window -t \"\$session_name:1\"
    tmux switch-client -t \"\$session_name\"
  fi
"

# System monitoring workspace (Alt+2)
bind -n M-2 run-shell "
  session_name=\"monitor-\$(date +%m%d)\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -n 'processes'
    tmux send-keys -t \"\$session_name:1\" 'btm' C-m
    tmux new-window -t \"\$session_name:2\" -n 'network'
    tmux send-keys -t \"\$session_name:2\" 'nload' C-m
    tmux new-window -t \"\$session_name:3\" -n 'disk'
    tmux send-keys -t \"\$session_name:3\" 'df -h; echo; du -sh ~/* | sort -hr | head -20' C-m
    tmux new-window -t \"\$session_name:4\" -n 'logs'
    tmux send-keys -t \"\$session_name:4\" 'journalctl -f' C-m
    tmux switch-client -t \"\$session_name\"
  fi
"

# Quick notes workspace (Alt+3)
bind -n M-3 run-shell "
  notes_dir=\"\$HOME/notes\"
  mkdir -p \"\$notes_dir\"
  session_name=\"notes\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -c \"\$notes_dir\" -n 'editor'
    tmux send-keys -t \"\$session_name:1\" 'nvim' C-m
    tmux new-window -t \"\$session_name:2\" -n 'scratch' -c \"\$notes_dir\"
    tmux send-keys -t \"\$session_name:2\" 'nvim scratchpad.md' C-m
    tmux new-window -t \"\$session_name:3\" -n 'browser' -c \"\$notes_dir\"
    tmux switch-client -t \"\$session_name\"
  fi
"

# Database workspace (Alt+4)
bind -n M-4 run-shell "
  session_name=\"database\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -n 'postgres'
    tmux send-keys -t \"\$session_name:1\" 'psql' C-m
    tmux new-window -t \"\$session_name:2\" -n 'redis'
    tmux send-keys -t \"\$session_name:2\" 'redis-cli' C-m
    tmux new-window -t \"\$session_name:3\" -n 'mysql'
    tmux send-keys -t \"\$session_name:3\" 'mysql' C-m
    tmux switch-client -t \"\$session_name\"
  fi
"

##### =====================================================
##### PANE MANAGEMENT
##### =====================================================

# Seamless vim/tmux navigation
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Smart splits (preserve current directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Pane movement with Alt+arrows
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Pane resizing with Ctrl+Alt+arrows
bind -n C-M-Left resize-pane -L 5
bind -n C-M-Right resize-pane -R 5
bind -n C-M-Up resize-pane -U 3
bind -n C-M-Down resize-pane -D 3

# Pane layout cycling
bind Space next-layout

# Maximize/minimize pane zoom
bind + resize-pane -Z

##### =====================================================
##### UTILITIES & PRODUCTIVITY
##### =====================================================

# Quick config reload
unbind r
bind r source-file ~/.tmux.conf \; display-message "✅ tmux config reloaded"

# Toggle status bar
bind b set-option status

# Display pane numbers
bind q display-panes

# Copy mode with vi bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Quick file browser
bind F run-shell "
  file=\$(find ~/ -type f 2>/dev/null | \
    fzf --reverse \
        --prompt='󰈞  Open file > ' \
        --height 70% \
        --preview='bat --color=always {}' \
        --preview-window='right,60%')
  
  if [ -n \"\$file\" ]; then
    tmux send-keys \"nvim '\$file'\" C-m
  fi
"

# Quick command runner
bind C run-shell "
  cmd=\$(echo | fzf --print-query --prompt='󰘧  Run command > ' | head -n1)
  
  if [ -n \"\$cmd\" ]; then
    tmux send-keys \"\$cmd\" C-m
  fi
"

# Git dashboard (requires lazygit)
bind G run-shell "tmux new-window -n 'git' 'lazygit' 2>/dev/null || tmux display-message 'Install lazygit first'"

# Show keybindings help
bind ? run-shell "
  clear && echo '
  󰀼  TMUX WORKSPACE NAVIGATION
  ─────────────────────────────
  Ctrl+f    󰀂  Fuzzy find sessions
  Ctrl+n    󰑐  New session from directory
  Ctrl+k    󰮯  Kill sessions
  Ctrl+w    󰀂  Fuzzy find windows
  Ctrl+p    󰀂  Fuzzy find panes
  Ctrl+Shift+n  New window with name
  
  󰯉  PANE MANAGEMENT
  ─────────────────────
  | -        Split horizontally/vertically
  C-hjkl     Navigate panes (Vim style)
  M-arrows   Navigate panes (Alt)
  C-M-arrows Resize panes
  +          Zoom pane
  Space      Cycle layouts
  
  󰓋  WORKSPACE PRESETS
  ─────────────────────
  Alt+1      Development workspace
  Alt+2      System monitoring
  Alt+3      Notes workspace
  Alt+4      Database workspace
  
  󰊴  UTILITIES
  ──────────────
  r          Reload config
  b          Toggle status bar
  F          File browser
  G          Git dashboard
  ?          Show this help
  
  Press any key to continue...' && read -n1
"

##### =====================================================
##### SESSION ORGANIZATION
##### =====================================================

# Session tree view
bind T choose-tree -Zs

# Rename session
bind R command-prompt -I "#S" -p "New session name:" "rename-session '%%'"

# Rename window
bind W command-prompt -I "#W" -p "New window name:" "rename-window '%%'"

# Detach from session
bind d detach-client

# List all sessions
bind L run-shell "
  clear
  echo '󰓋  ACTIVE SESSIONS'
  echo '════════════════════════════════════════'
  tmux list-sessions -F '#{?session_attached,󰅂 ,  }#{session_name} (#{session_windows} windows, #{session_attached} attached)'
  echo ''
  echo '󱂬  Press any key to continue...'
  read -n1
"

##### =====================================================
##### MIGRATION & COMPATIBILITY
##### =====================================================

# Legacy prefix support (Ctrl+b still works)
set -g prefix C-b
unbind C-b
bind C-b send-prefix

# Alternative prefix for those who prefer Ctrl+a
set -g prefix2 C-a
bind C-a send-prefix -2

##### =====================================================
##### TPM INITIALIZATION (MUST BE LAST)
##### =====================================================

# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
