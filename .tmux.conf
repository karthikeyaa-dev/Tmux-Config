# ========================================================
# TMUX ULTIMATE WORKSPACE CONFIGURATION
# Version: 2.0 - Dashboard Edition
# ========================================================

##### META CONFIGURATION #####

# Version check
if-shell '[ "$(echo "$TMUX_VERSION >= 3.2" | bc)" = 1 ]' 'set -g @tmux_version "modern"' 'set -g @tmux_version "legacy"'

##### CORE SETTINGS #####

set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB,tmux-256color:RGB"
set -g default-command "${SHELL}"
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g automatic-rename off
set -g allow-rename off
set -g set-clipboard on
set -g focus-events on
set -sg escape-time 0
set -g history-limit 50000
set -g display-time 4000
set -g display-panes-time 2000
set -g status-keys emacs
set -g mode-keys vi
set -g mouse on
set -g monitor-activity on
set -g visual-activity off
set -g visual-bell off
set -g bell-action none

##### PLUGIN MANAGEMENT #####

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-git'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'rickstaa/tmux-notify'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'

# Optional plugins (uncomment if needed)
# set -g @plugin 'nhdaly/tmux-better-mouse-mode'
# set -g @plugin 'wfxr/tmux-fzf-url'
# set -g @plugin 'MunifTanjim/tmux-mode-indicator'
# set -g @plugin 'jaclu/tmux-menus'

##### PERSISTENCE & RESTORE #####

##### DISABLE AUTO-RESTORE #####

# Turn off continuum auto-restore
set -g @continuum-restore 'off'

# Turn off continuum auto-boot
set -g @continuum-boot 'off'

# Disable resurrect auto-save
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'
set -g @continuum-boot-options 'fullscreen'
set -g @continuum-save-interval '5'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes 'ssh psql mysql sqlite3 python ipython irb node nvim vim'
set -g @resurrect-strategy-nvim 'session'

##### THEME - CATPPUCCIN MOCHA #####

set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_window_left_separator ""
set -g @catppuccin_window_right_separator " "
set -g @catppuccin_window_middle_separator "  "
set -g @catppuccin_window_number_position "right"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_window_current_text "#W"
set -g @catppuccin_status_modules_right "directory session date_time"
set -g @catppuccin_status_left_separator  ""
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"
set -g @catppuccin_directory_text "#{pane_current_path}"

##### PANE STYLING #####

set -g pane-border-style "fg=#585b70"
set -g pane-active-border-style "fg=#f5c2e7,bg=#1e1e2e"
set -g display-panes-colour "#f5c2e7"
set -g display-panes-active-colour "#cba6f7"

##### STATUS BAR #####

##### ULTIMATE BEAUTIFUL STATUS BAR #####

set -g status on
set -g status-position top
set -g status-interval 1
set -g status-justify centre
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

set -g status-left-length 160
set -g status-right-length 220

# Left: Individual semicircles for each section
# Add this to your tmux config
set -g status-left "\
#[fg=#f5c2e7]#[fg=#1e1e2e,bg=#f5c2e7,bold] 󰆍 #S #[fg=#f5c2e7,bg=#1e1e2e] \
#[fg=#cba6f7]#[fg=#1e1e2e,bg=#cba6f7] 󰖟 #I #[fg=#cba6f7,bg=#1e1e2e] \
#[fg=#a6e3a1]#[fg=#1e1e2e,bg=#a6e3a1] 󰉋 #($HOME/.config/tmux/truncate_path.sh #{pane_current_path}) #[fg=#a6e3a1,bg=#1e1e2e]"

# Make window status empty
setw -g window-status-format ""
setw -g window-status-current-format ""
setw -g window-status-separator ""

# Or use a single space to keep alignment
setw -g window-status-format " "
setw -g window-status-current-format " "

# Right: Beautiful info dashboard with Git colors
# Right: Beautiful info dashboard with Git colors and semicircles
# Right: Beautiful info dashboard with semicircles
set -g status-right "\
#[fg=#89dceb]#[fg=#1e1e2e,bg=#89dceb]  #{cpu_percentage} \
#[fg=#89dceb,bg=#f9e2af]#[fg=#1e1e2e,bg=#f9e2af] 󰍛 #{ram_percentage} \
#[fg=#f9e2af,bg=#fab387]#[fg=#1e1e2e,bg=#fab387] 󰁿 #{battery_percentage} \
#[fg=#fab387,bg=#89b4fa]#[fg=#1e1e2e,bg=#89b4fa] 󰃭 %d %b \
#[fg=#89b4fa,bg=#cba6f7]#[fg=#1e1e2e,bg=#cba6f7] 󰥔 %H:%M #[fg=#cba6f7,bg=#1e1e2e]"
##### TELESCOPE-STYLE WORKSPACE NAVIGATION
##### =====================================================

# ===============================
# tmux-fzf configuration
# ===============================

# -------------------------------
# Launch key
# -------------------------------
# Default: prefix + f
# For Ctrl+F use: set -g @tmux_fzf_launch_key 'C-f'
set -g @tmux_fzf_launch_key 'f'
set -g @tmux_fzf_options "-p -w 52% -h 38% -m"
set -g @tmux_fzf_preview 1
set -g @tmux_fzf_preview_follow 1
set -g @tmux_fzf_order "󰆍 session|󰖯 window|󰓩 pane|󰘳 command|󰌌 keybinding|󰅍 clipboard|󰩺 process"

# ASCII fallback (use this if icons don't render)
# set -g @tmux_fzf_order "session|window|pane|command|keybinding|clipboard|process"

# -------------------------------
# Listing formats
# -------------------------------
set -g @tmux_fzf_session_format "[#{session_name}] #{session_windows} windows #{session_width}x#{session_height}"

set -g @tmux_fzf_window_format  "[#{window_index}] #{window_name} \
[#{window_panes} panes] \
#{?window_active,[active],[inactive]}"

set -g @tmux_fzf_pane_format    "[#{window_name}] #{pane_current_command} \
[#{pane_width}x#{pane_height}] \
[history #{history_size}/#{history_limit}] \
#{?pane_active,[active],[inactive]}"

# -------------------------------
# Switching behavior
# -------------------------------
# Include current session/window/pane in switchers
set -g @tmux_fzf_switch_current 1

# -------------------------------
# User menu
# -------------------------------
# Format:
# name\n
# command\n
# \n
set -g @tmux_fzf_menu "foo\n\
echo 'Hello!'\n\
\n""\
bar\n\
ls ~\n\
\n""\
sh\n\
sh ~/test.sh\n\
\n""\
nil--\n\n"

# Show user menu in popup
set -g @tmux_fzf_menu_popup 1
set -g @tmux_fzf_menu_popup_width  "50%"
set -g @tmux_fzf_menu_popup_height "50%"

# -------------------------------
# Notes
# -------------------------------
# - Launch with prefix + f
# - TAB / Shift-TAB for multi-select
# - Requires fzf in PATH
# - Install via TPM and reload tmux


##### =====================================================
##### WORKSPACE PRESETS
##### =====================================================

bind-key S command-prompt -p "Session name:" \
"new-session -As '%%' \; display-popup -E \"echo Switched to session: %%; sleep 2\" -x R -y T -w 30 -h 3"


bind-key W command-prompt -p "Window name:" \
"new-window -n '%%' \; display-popup -E \"echo Switched to window: %%; sleep 2\" -x R -y T -w 30 -h 3"


# Development workspace (Alt+1)
bind -n M-1 run-shell "
  session_name=\"dev-\$(date +%Y%m%d)\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -c ~/projects -n 'editor'
    tmux send-keys -t \"\$session_name:1\" 'clear' C-m
    tmux new-window -t \"\$session_name:2\" -n 'server' -c ~/projects
    tmux new-window -t \"\$session_name:3\" -n 'shell' -c ~/projects
    tmux new-window -t \"\$session_name:4\" -n 'logs' -c ~/projects
    tmux new-window -t \"\$session_name:5\" -n 'git' -c ~/projects
    tmux select-window -t \"\$session_name:1\"
    tmux switch-client -t \"\$session_name\"
  fi
"

# System monitoring workspace (Alt+2)
bind -n M-2 run-shell "
  session_name=\"monitor-\$(date +%m%d)\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -n 'processes'
    tmux send-keys -t \"\$session_name:1\" 'btm' C-m
    tmux new-window -t \"\$session_name:2\" -n 'network'
    tmux send-keys -t \"\$session_name:2\" 'nload' C-m
    tmux new-window -t \"\$session_name:3\" -n 'disk'
    tmux send-keys -t \"\$session_name:3\" 'df -h; echo; du -sh ~/* | sort -hr | head -20' C-m
    tmux new-window -t \"\$session_name:4\" -n 'logs'
    tmux send-keys -t \"\$session_name:4\" 'journalctl -f' C-m
    tmux switch-client -t \"\$session_name\"
  fi
"

# Quick notes workspace (Alt+3)
bind -n M-3 run-shell "
  notes_dir=\"\$HOME/notes\"
  mkdir -p \"\$notes_dir\"
  session_name=\"notes\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -c \"\$notes_dir\" -n 'editor'
    tmux send-keys -t \"\$session_name:1\" 'nvim' C-m
    tmux new-window -t \"\$session_name:2\" -n 'scratch' -c \"\$notes_dir\"
    tmux send-keys -t \"\$session_name:2\" 'nvim scratchpad.md' C-m
    tmux new-window -t \"\$session_name:3\" -n 'browser' -c \"\$notes_dir\"
    tmux switch-client -t \"\$session_name\"
  fi
"

# Database workspace (Alt+4)
bind -n M-4 run-shell "
  session_name=\"database\"
  
  if tmux has-session -t=\"\$session_name\" 2>/dev/null; then
    tmux switch-client -t \"\$session_name\"
  else
    tmux new-session -d -s \"\$session_name\" -n 'postgres'
    tmux send-keys -t \"\$session_name:1\" 'psql' C-m
    tmux new-window -t \"\$session_name:2\" -n 'redis'
    tmux send-keys -t \"\$session_name:2\" 'redis-cli' C-m
    tmux new-window -t \"\$session_name:3\" -n 'mysql'
    tmux send-keys -t \"\$session_name:3\" 'mysql' C-m
    tmux switch-client -t \"\$session_name\"
  fi
"

##### =====================================================
##### PANE MANAGEMENT
##### =====================================================

# Seamless vim/tmux navigation
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Smart splits (preserve current directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Pane movement with Alt+arrows
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Pane resizing with Ctrl+Alt+arrows
bind -n C-M-Left resize-pane -L 5
bind -n C-M-Right resize-pane -R 5
bind -n C-M-Up resize-pane -U 3
bind -n C-M-Down resize-pane -D 3

# Pane layout cycling
bind Space next-layout

# Maximize/minimize pane zoom
bind + resize-pane -Z

##### =====================================================
##### UTILITIES & PRODUCTIVITY
##### =====================================================

# Quick config reload
unbind r
bind r source-file ~/.tmux.conf \; display-message "✅ tmux config reloaded"

# Toggle status bar
bind b set-option status

# Display pane numbers
bind q display-panes

# Copy mode with vi bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Quick file browser
bind F run-shell "
  file=\$(find ~/ -type f 2>/dev/null | \
    fzf --reverse \
        --prompt='󰈞  Open file > ' \
        --height 70% \
        --preview='bat --color=always {}' \
        --preview-window='right,60%')
  
  if [ -n \"\$file\" ]; then
    tmux send-keys \"nvim '\$file'\" C-m
  fi
"

# Quick command runner
bind C run-shell "
  cmd=\$(echo | fzf --print-query --prompt='󰘧  Run command > ' | head -n1)
  
  if [ -n \"\$cmd\" ]; then
    tmux send-keys \"\$cmd\" C-m
  fi
"

# Git dashboard (requires lazygit)
bind G run-shell "tmux new-window -n 'git' 'lazygit' 2>/dev/null || tmux display-message 'Install lazygit first'"

# Show keybindings help
bind ? run-shell "
  clear && echo '
  󰀼  TMUX WORKSPACE NAVIGATION
  ─────────────────────────────
  Ctrl+f    󰀂  Fuzzy find sessions
  Ctrl+n    󰑐  New session from directory
  Ctrl+k    󰮯  Kill sessions
  Ctrl+w    󰀂  Fuzzy find windows
  Ctrl+p    󰀂  Fuzzy find panes
  Ctrl+Shift+n  New window with name
  
  󰯉  PANE MANAGEMENT
  ─────────────────────
  | -        Split horizontally/vertically
  C-hjkl     Navigate panes (Vim style)
  M-arrows   Navigate panes (Alt)
  C-M-arrows Resize panes
  +          Zoom pane
  Space      Cycle layouts
  
  󰓋  WORKSPACE PRESETS
  ─────────────────────
  Alt+1      Development workspace
  Alt+2      System monitoring
  Alt+3      Notes workspace
  Alt+4      Database workspace
  
  󰊴  UTILITIES
  ──────────────
  r          Reload config
  b          Toggle status bar
  F          File browser
  G          Git dashboard
  ?          Show this help
  
  Press any key to continue...' && read -n1
"

##### =====================================================
##### SESSION ORGANIZATION
##### =====================================================

# Session tree view
bind T choose-tree -Zs

# Rename session
bind R command-prompt -I "#S" -p "New session name:" "rename-session '%%'"

# Detach from session
bind d detach-client

# List all sessions
bind L run-shell "
  clear
  echo '󰓋  ACTIVE SESSIONS'
  echo '════════════════════════════════════════'
  tmux list-sessions -F '#{?session_attached,󰅂 ,  }#{session_name} (#{session_windows} windows, #{session_attached} attached)'
  echo ''
  echo '󱂬  Press any key to continue...'
  read -n1
"

##### =====================================================
##### MIGRATION & COMPATIBILITY
##### =====================================================

# Legacy prefix support (Ctrl+b still works)
set -g prefix C-b
unbind C-b
bind C-b send-prefix

# Alternative prefix for those who prefer Ctrl+a
set -g prefix2 C-a
bind C-a send-prefix -2

##### =====================================================
##### TPM INITIALIZATION (MUST BE LAST)
##### =====================================================

# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
